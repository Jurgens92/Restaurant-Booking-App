{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Book a Table - La Dolce Vita{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <h1 class="mb-4">Book a Table</h1>
        
        {% if user.is_authenticated %}
            <form method="post" id="booking-form">
                {% csrf_token %}
                {{ form|crispy }}
                
                <div id="time-slots-container" class="mt-3 mb-3" style="display: none;">
                    <label class="form-label">Available Time Slots:</label>
                    <div id="time-slots" class="d-flex flex-wrap gap-2"></div>
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">Make Reservation</button>
            </form>
        {% else %}
            <div class="alert alert-info">
                <p>Please <a href="{% url 'login' %}">login</a> or <a href="{% url 'register' %}">register</a> to make a booking.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="booking_date"]');
    const partySizeInput = document.querySelector('input[name="party_size"]');
    const timeInput = document.querySelector('input[name="booking_time"]');
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const timeSlotsDiv = document.getElementById('time-slots');
    
    // Function to check availability when date or party size changes
    function checkAvailability() {
        const date = dateInput.value;
        const partySize = partySizeInput.value;
        
        if (date && partySize) {
            // Show loading state
            timeSlotsDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            timeSlotsContainer.style.display = 'block';
            
            // Make API request
            fetch(`/check-availability/?date=${date}&party_size=${partySize}`)
                .then(response => response.json())
                .then(data => {
                    timeSlotsDiv.innerHTML = '';
                    
                    if (data.available_slots) {
                        data.available_slots.forEach(slot => {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = slot.available ? 
                                'btn btn-outline-success time-slot' : 
                                'btn btn-outline-secondary disabled';
                            button.textContent = slot.time;
                            
                            if (slot.available) {
                                button.addEventListener('click', function() {
                                    // Set the time input value when a slot is clicked
                                    timeInput.value = slot.time;
                                    
                                    // Remove active class from all buttons
                                    document.querySelectorAll('.time-slot').forEach(btn => {
                                        btn.classList.remove('active');
                                    });
                                    
                                    // Add active class to the clicked button
                                    button.classList.add('active');
                                });
                            }
                            
                            timeSlotsDiv.appendChild(button);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    timeSlotsDiv.innerHTML = '<div class="alert alert-danger">Error checking availability</div>';
                });
        } else {
            timeSlotsContainer.style.display = 'none';
        }
    }
    
    // Add event listeners
    dateInput.addEventListener('change', checkAvailability);
    partySizeInput.addEventListener('change', checkAvailability);
});
</script>
{% endblock %}